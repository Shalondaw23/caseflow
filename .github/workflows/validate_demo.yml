name: Validate Demo

on:
  workflow_dispatch:
  push:
    branches: f-gh-migration

jobs:
  validate-demo:
    runs-on: ubuntu-8-cores-latest
    services:
      postgres:
        image: postgres:11.7
        env:
          POSTGRES_USER: root
          POSTGRES_PASSWORD: password
          POSTGRES_DB: caseflow_certification_test
        ports:
        - 5432:5432
      redis:
        image: redis:4.0.10
        ports:
        - 6379:6379
      facols:
        image: 008577686731.dkr.ecr.us-gov-west-1.amazonaws.com/facols:latest
        credentials:
          username: AWS
          password: ${{ secrets.ECR_PASSWORD }}
    container:
      image: 008577686731.dkr.ecr.us-gov-west-1.amazonaws.com/gaimg-ruby:2.7.3-ga-browsers
      credentials:
        username: AWS
        password: ${{ secrets.ECR_PASSWORD }}
      env:
          DBUS_SESSION_BUS_ADDRESS: /dev/null
          RAILS_ENV: test
          NODE_ENV: test
          BUNDLE_PATH: vendor/bundle
          COVERAGE_DIR: /home/circleci/coverage
          POSTGRES_HOST: localhost
          POSTGRES_USER: root
    steps:
      - uses: actions/checkout@v3

      - name: restore yarn cache
        uses: actions/cache/restore@v3
        with:
          key: dot-cache-yarn-v2-{{ arch }}-{{ checksum "client/yarn.lock" }}
          path: |
            ~/.cache/yarn
            public/assets
            tmp/cache/assets/sprockets
          restore-keys:
            dot-cache-yarn-v2-{{ arch }}-{{ checksum "client/yarn.lock" }}

      - name: Install Node Dependencies
        run: ./ci-bin/capture-log "cd client && yarn install --frozen-lockfile"

      - name: Save Cache
        uses: actions/cache@v3
        with:
          key: dot-cache-yarn-v2-{{ arch }}-{{ checksum "client/yarn.lock" }}
          path: |
            ~/.cache/yarn
            public/assets
            tmp/cache/assets/sprockets
          restore-keys:
            dot-cache-yarn-v2-{{ arch }}-{{ checksum "client/yarn.lock" }}

      - name: Install chromium
        run: |
          CHROME_VERSION="106.0.5249.119-1"
          apt-get update
          wget --no-verbose -O /tmp/chrome.deb https://dl.google.com/linux/chrome/deb/pool/main/g/google-chrome-stable/google-chrome-stable_${CHROME_VERSION}_amd64.deb \
          && apt install -y /tmp/chrome.deb \
          && rm /tmp/chrome.deb

      - name: Install firefox
        run: |
          FIREFOX_VERSION="106.0.1"
          apt-get -y install libgtk2.0-0
          wget https://ftp.mozilla.org/pub/firefox/releases/${FIREFOX_VERSION}/linux-x86_64/en-GB/firefox-${FIREFOX_VERSION}.tar.bz2
          tar xvf firefox-45.0.2.tar.bz2
          mv firefox/ /usr/lib/firefox
          ln -s /usr/lib/firefox /usr/bin/firefox

      - name: setup testfiles directory
        run: ./ci-bin/capture-log "mkdir -p ~/project/tmp/testfiles"




