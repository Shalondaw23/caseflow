<!-- sidebar start -->
<aside>
  {{ with .Site.GetPage "/menu/header" }}
    {{- $href := printf "href=\"%s\"" $.RelPermalink -}}
    {{- replace .Content $href (print $href "class=active") | safeHTML -}}
  {{ end }}
  <ul>
    {{ $currentPage := . }}
    {{ $visibleMenuItems := (where .Site.Menus.navmenu "Weight" "gt" 0 ) }}
    {{ $sortedMenuItems := (sort (sort $visibleMenuItems "Page.Weight") "Weight") }}
    {{ range $sortedMenuItems }}
      {{ $sectionId := print "section-" .Identifier }}
      <li id="{{ $sectionId }}">
        {{ $scratch := newScratch }}
        <!-- https://gohugo.io/templates/menu-templates/#using-page-in-menus -->
        <!-- `with` dereferences `.Page` so that an error doesn't occur if it is null -->
        {{with .Page}}{{ $scratch.Set "page" .Page }}{{end}}
        {{ $pageViaMenu := $scratch.Get "page" }}
        {{ $linkLabel := (.Name | default .Title | default .Identifier | default .URL) }}
        {{ if .HasChildren }}
          {{ $inputId := print "input-" $sectionId }}
          {{ $collapsible := $pageViaMenu.Params.menu.navmenu.collapsible }}
          {{ $active := ($currentPage.IsMenuCurrent "navmenu" .) }}
          <!-- hasactive is false if it is active -->
          {{ $hasactive := cond $active false ($currentPage.HasMenuCurrent "navmenu" .) }}
          {{ if $collapsible }}
            <input type="checkbox" id="{{ $inputId }}" class="toggle" {{ if or $active $hasactive }} checked{{ end }} />
          {{ end }}
          <label for="{{ $inputId }}" class="flex justify-between {{ if $hasactive }}hasactive{{ end }} {{ if $active }}active{{ end }}">
            <a href="{{ .URL }}" class="{{ if $hasactive }}hasactive{{ end }} {{ if $active }}active{{ end }}">
              {{- $linkLabel -}}
            </a>
          </label>
          <ul class="sub-menu">
            {{ range (sort (sort .Children "Page.Weight") "Weight") }}
              {{with .Page}}{{ $scratch.Set "childpage" .Page }}{{end}}
              {{ $childpageViaMenu := $scratch.Get "childpage" }}
              {{ $childLinkLabel := (.Name | default .Title | default .Identifier | default .URL) }}
              <li class="{{ if $currentPage.IsMenuCurrent "navmenu" . }}active{{ end }}">
                <a href="{{ .URL }}">{{- $childLinkLabel -}}</a>
              </li>
            {{ end }}
          </ul>
        {{ else }}
          <a href="{{ .URL }}" class="{{ if $currentPage.IsMenuCurrent "navmenu" . }}active{{ end }}">
            {{ .Pre }}
            <span>{{- $linkLabel -}}</span>
          </a>
        {{ end }}
      </li>
    {{ end }}
  </ul>
  {{ with .Site.GetPage "/menu/footer" }}
    {{- $href := printf "href=\"%s\"" $.RelPermalink -}}
    {{- replace .Content $href (print $href "class=active") | safeHTML -}}
  {{ end }}
</aside>